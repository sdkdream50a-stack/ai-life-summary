<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Test Lab - Profile</title>
  <meta name="description" content="AI Test Lab - My Profile">
  <meta name="robots" content="noindex">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="../favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CSS (Local Build) -->
  <link rel="stylesheet" href="../css/tailwind.css" fetchpriority="high">
  <!-- Global KICK Design System -->
  <link rel="stylesheet" href="../css/global-kick.css">
  <!-- Gamification Styles -->
  <link rel="stylesheet" href="../css/gamification.css">
  <link rel="stylesheet" href="../css/popups.css">
  <link rel="stylesheet" href="../css/profile.css">

  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Language switching */
    .lang-ko, .lang-ja, .lang-zh, .lang-es { display: none; }
    html[lang="ko"] .lang-en, html[lang="ko"] .lang-ja, html[lang="ko"] .lang-zh, html[lang="ko"] .lang-es { display: none; }
    html[lang="ko"] .lang-ko { display: inline; }
    html[lang="ja"] .lang-en, html[lang="ja"] .lang-ko, html[lang="ja"] .lang-zh, html[lang="ja"] .lang-es { display: none; }
    html[lang="ja"] .lang-ja { display: inline; }
    html[lang="zh"] .lang-en, html[lang="zh"] .lang-ko, html[lang="zh"] .lang-ja, html[lang="zh"] .lang-es { display: none; }
    html[lang="zh"] .lang-zh { display: inline; }
    html[lang="es"] .lang-en, html[lang="es"] .lang-ko, html[lang="es"] .lang-ja, html[lang="es"] .lang-zh { display: none; }
    html[lang="es"] .lang-es { display: inline; }
  </style>

  <!-- Early Language Detection -->
  <script>
  (function() {
    var supportedLangs = ['en', 'ko', 'ja', 'zh', 'es'];
    var saved = localStorage.getItem('ai-life-summary-lang');
    var lang = 'ko';
    if (saved && supportedLangs.indexOf(saved) !== -1) {
      lang = saved;
    } else {
      var browserLangs = navigator.languages || [navigator.language];
      var langCodes = browserLangs.map(function(l) { return l.split('-')[0].toLowerCase(); });
      if (langCodes.indexOf('ko') !== -1) {
        lang = 'ko';
      } else {
        for (var i = 0; i < langCodes.length; i++) {
          if (supportedLangs.indexOf(langCodes[i]) !== -1) { lang = langCodes[i]; break; }
        }
      }
    }
    document.documentElement.lang = lang;
  })();
  </script>

  <!-- Language Switching Script -->
  <script>
  var langNames = { en: 'EN', ko: 'í•œêµ­ì–´', ja: 'æ—¥æœ¬èª', zh: 'ä¸­æ–‡', es: 'ES' };
  var langFlags = { en: 'ğŸ‡ºğŸ‡¸', ko: 'ğŸ‡°ğŸ‡·', ja: 'ğŸ‡¯ğŸ‡µ', zh: 'ğŸ‡¨ğŸ‡³', es: 'ğŸ‡ªğŸ‡¸' };

  function switchLang(lang) {
    localStorage.setItem('ai-life-summary-lang', lang);
    localStorage.setItem('preferredLanguage', lang);
    document.documentElement.lang = lang;
    var currentLangEl = document.getElementById('current-lang');
    if (currentLangEl) {
      currentLangEl.textContent = langFlags[lang] + ' ' + langNames[lang];
    }
    var dropdown = document.getElementById('lang-dropdown');
    if (dropdown) dropdown.classList.add('hidden');
    // Re-apply i18n translations
    if (typeof applyTranslations === 'function') {
      currentLang = lang;
      applyTranslations();
    }
  }

  function toggleLangDropdown() {
    var dropdown = document.getElementById('lang-dropdown');
    if (dropdown) dropdown.classList.toggle('hidden');
  }

  document.addEventListener('click', function(e) {
    var langSelector = document.getElementById('lang-selector');
    var dropdown = document.getElementById('lang-dropdown');
    if (langSelector && dropdown && !langSelector.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });
  </script>
</head>
<body class="kick-mesh-bg text-white min-h-screen">
  <!-- Floating Pill Navbar -->
  <nav class="kick-navbar" id="floating-navbar">
    <a href="/" class="kick-navbar-logo">
      <span class="text-xl">ğŸ”®</span>
      <span class="kick-gradient-text">AI Test Lab</span>
    </a>
    <div class="kick-navbar-links">
      <a href="/compatibility/" class="kick-navbar-link">â¤ï¸â€ğŸ”¥ <span class="lang-en">Compatibility</span><span class="lang-ko">ê¶í•©</span><span class="lang-ja">ç›¸æ€§</span><span class="lang-zh">é…å¯¹</span><span class="lang-es">Compatibilidad</span></a>
      <a href="/life-summary/" class="kick-navbar-link">ğŸ”® <span class="lang-en">Soul</span><span class="lang-ko">ì†Œìš¸</span><span class="lang-ja">ã‚½ã‚¦ãƒ«</span><span class="lang-zh">çµé­‚</span><span class="lang-es">Alma</span></a>
      <a href="/age-calculator/" class="kick-navbar-link">â³ <span class="lang-en">Age</span><span class="lang-ko">ë‚˜ì´</span><span class="lang-ja">å¹´é½¢</span><span class="lang-zh">å¹´é¾„</span><span class="lang-es">Edad</span></a>
    </div>
    <!-- Language Selector -->
    <div id="lang-selector" class="relative">
      <button onclick="toggleLangDropdown()" class="kick-navbar-link flex items-center gap-1">
        <span id="current-lang">ğŸ‡°ğŸ‡· í•œêµ­ì–´</span>
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </button>
      <div id="lang-dropdown" class="hidden absolute right-0 top-full mt-2 w-28 bg-gray-900/95 backdrop-blur-lg rounded-xl border border-white/10 py-1 z-50">
        <button onclick="switchLang('en')" class="w-full text-left px-3 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">ğŸ‡ºğŸ‡¸ EN</button>
        <button onclick="switchLang('ko')" class="w-full text-left px-3 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
        <button onclick="switchLang('ja')" class="w-full text-left px-3 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
        <button onclick="switchLang('zh')" class="w-full text-left px-3 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
        <button onclick="switchLang('es')" class="w-full text-left px-3 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">ğŸ‡ªğŸ‡¸ ES</button>
      </div>
    </div>
    <!-- Settings Button -->
    <button id="btn-settings" class="kick-navbar-link" aria-label="Settings">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      </svg>
    </button>
    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="md:hidden text-white p-1">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
  </nav>

  <!-- Mobile Menu Overlay -->
  <div id="mobile-menu" class="hidden fixed inset-0 z-[999] bg-black/90 backdrop-blur-xl">
    <div class="flex flex-col items-center justify-center h-full gap-6 text-center">
      <button id="mobile-menu-close" class="absolute top-6 right-6 text-white text-3xl">&times;</button>
      <a href="/compatibility/" class="text-2xl text-white font-bold hover:text-pink-400 transition">â¤ï¸â€ğŸ”¥ <span class="lang-en">Compatibility</span><span class="lang-ko">ê¶í•© í…ŒìŠ¤íŠ¸</span><span class="lang-ja">ç›¸æ€§è¨ºæ–­</span><span class="lang-zh">é…å¯¹æµ‹è¯•</span><span class="lang-es">Compatibilidad</span></a>
      <a href="/life-summary/" class="text-2xl text-white font-bold hover:text-purple-400 transition">ğŸ”® <span class="lang-en">Soul Type</span><span class="lang-ko">ì†Œìš¸ íƒ€ì…</span><span class="lang-ja">ã‚½ã‚¦ãƒ«ã‚¿ã‚¤ãƒ—</span><span class="lang-zh">çµé­‚ç±»å‹</span><span class="lang-es">Tipo de Alma</span></a>
      <a href="/age-calculator/" class="text-2xl text-white font-bold hover:text-cyan-400 transition">â³ <span class="lang-en">Mental Age</span><span class="lang-ko">ì •ì‹  ë‚˜ì´</span><span class="lang-ja">ç²¾ç¥å¹´é½¢</span><span class="lang-zh">å¿ƒç†å¹´é¾„</span><span class="lang-es">Edad Mental</span></a>
      <div class="border-t border-white/20 w-48 my-4"></div>
      <a href="/about.html" class="text-lg text-white/70 hover:text-white transition"><span class="lang-en">About</span><span class="lang-ko">ì†Œê°œ</span><span class="lang-ja">æ¦‚è¦</span><span class="lang-zh">å…³äº</span><span class="lang-es">Acerca de</span></a>
      <a href="/blog.html" class="text-lg text-white/70 hover:text-white transition">Blog</a>
      <a href="/profile/" class="text-lg text-purple-400 font-bold">ğŸ‘¤ <span class="lang-en">Profile</span><span class="lang-ko">í”„ë¡œí•„</span><span class="lang-ja">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span><span class="lang-zh">æ¡£æ¡ˆ</span><span class="lang-es">Perfil</span></a>
      <div class="flex gap-3 mt-4">
        <button onclick="switchLang('en'); document.getElementById('mobile-menu').classList.add('hidden');" class="px-3 py-1 text-sm bg-white/10 text-white rounded-full hover:bg-white/20">ğŸ‡ºğŸ‡¸</button>
        <button onclick="switchLang('ko'); document.getElementById('mobile-menu').classList.add('hidden');" class="px-3 py-1 text-sm bg-white/10 text-white rounded-full hover:bg-white/20">ğŸ‡°ğŸ‡·</button>
        <button onclick="switchLang('ja'); document.getElementById('mobile-menu').classList.add('hidden');" class="px-3 py-1 text-sm bg-white/10 text-white rounded-full hover:bg-white/20">ğŸ‡¯ğŸ‡µ</button>
        <button onclick="switchLang('zh'); document.getElementById('mobile-menu').classList.add('hidden');" class="px-3 py-1 text-sm bg-white/10 text-white rounded-full hover:bg-white/20">ğŸ‡¨ğŸ‡³</button>
        <button onclick="switchLang('es'); document.getElementById('mobile-menu').classList.add('hidden');" class="px-3 py-1 text-sm bg-white/10 text-white rounded-full hover:bg-white/20">ğŸ‡ªğŸ‡¸</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="profile-main relative z-10 pt-20">
    <!-- Profile Card -->
    <section class="profile-card-section">
      <div class="profile-card">
        <div class="profile-header-info">
          <div id="profile-avatar" class="profile-avatar">
            <span id="avatar-emoji">ğŸ˜Š</span>
          </div>
          <div class="profile-info">
            <h2 id="profile-name" class="profile-name">Guest User</h2>
            <div class="profile-level">
              <span id="level-badge" class="level-badge">
                Lv.<span id="level-number">1</span>
              </span>
              <span id="level-name" class="level-name">Soul Newbie</span>
            </div>
          </div>
        </div>

        <!-- XP Bar -->
        <div class="xp-bar-container">
          <div class="xp-bar-header">
            <span id="xp-text">0 / 100 XP</span>
            <span id="xp-next" class="text-xs text-gray-400">Next: Lv.2</span>
          </div>
          <div class="xp-bar">
            <div id="xp-bar-fill" class="xp-bar-fill" style="width: 0%"></div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="profile-stats">
          <div class="stat-item">
            <span class="stat-icon">ğŸ”¥</span>
            <div>
              <span id="stat-streak" class="stat-value">0</span>
              <span class="stat-label" data-i18n="streak">Day Streak</span>
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-icon">ğŸ“Š</span>
            <div>
              <span id="stat-tests" class="stat-value">0</span>
              <span class="stat-label" data-i18n="tests">Tests</span>
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-icon">ğŸ†</span>
            <div>
              <span id="stat-badges" class="stat-value">0</span>
              <span class="stat-label" data-i18n="badges">Badges</span>
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-icon">ğŸ“¤</span>
            <div>
              <span id="stat-shares" class="stat-value">0</span>
              <span class="stat-label" data-i18n="shares">Shares</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Login Prompt (for guests) -->
      <div id="login-prompt" class="login-prompt-banner hidden">
        <div class="login-prompt-text">
          <span data-i18n="loginPrompt">Login to save your progress!</span>
        </div>
        <button id="btn-login" class="login-prompt-btn" data-i18n="login">Login</button>
      </div>
    </section>

    <!-- Badges Section -->
    <section class="profile-section">
      <div class="section-header">
        <h3 class="section-title">
          <span>ğŸ…</span>
          <span data-i18n="myBadges">My Badges</span>
          <span id="badge-count" class="badge-count">(0/0)</span>
        </h3>
        <a href="#all-badges" class="section-link" data-i18n="viewAll">View All</a>
      </div>

      <div id="earned-badges" class="badge-grid">
        <!-- Badges will be populated by JS -->
      </div>

      <div class="locked-badges-header">
        <span data-i18n="lockedBadges">Locked Badges</span>
        <span id="locked-count">(0)</span>
      </div>
      <div id="locked-badges" class="badge-grid badge-grid-locked">
        <!-- Locked badges will be populated by JS -->
      </div>
    </section>

    <!-- Streak Section -->
    <section class="profile-section">
      <div class="section-header">
        <h3 class="section-title">
          <span>ğŸ”¥</span>
          <span data-i18n="streakStatus">Streak Status</span>
        </h3>
      </div>

      <div class="streak-card">
        <div class="streak-info">
          <div class="streak-current">
            <span id="streak-emoji" class="streak-fire">ğŸ”¥</span>
            <span id="streak-count" class="streak-count">0</span>
            <span class="streak-label" data-i18n="currentStreak">Current Streak</span>
          </div>
          <div class="streak-best">
            <span class="streak-best-label" data-i18n="longestStreak">Longest:</span>
            <span id="streak-best" class="streak-best-value">0</span>
            <span data-i18n="days">days</span>
          </div>
        </div>

        <div id="streak-week" class="streak-week">
          <!-- Week display will be populated by JS -->
        </div>

        <div id="streak-next-milestone" class="streak-milestone">
          <!-- Next milestone info -->
        </div>
      </div>
    </section>

    <!-- Test History Section -->
    <section class="profile-section">
      <div class="section-header">
        <h3 class="section-title">
          <span>ğŸ“Š</span>
          <span data-i18n="testHistory">Test History</span>
        </h3>
      </div>

      <div id="most-common-type" class="most-common-type hidden">
        <span data-i18n="mostCommon">Most Common Type:</span>
        <span id="common-type-name" class="type-name"></span>
        <span id="common-type-count" class="type-count"></span>
      </div>

      <div id="test-history-list" class="test-history-list">
        <!-- Test history will be populated by JS -->
        <div class="empty-state">
          <span>ğŸ“</span>
          <span data-i18n="noTests">No tests yet</span>
        </div>
      </div>
    </section>

    <!-- Invite Section -->
    <section class="profile-section">
      <div class="invite-section">
        <h3 class="invite-title" data-i18n="inviteFriends">Invite Friends</h3>
        <p class="invite-subtitle" data-i18n="inviteSubtitle">Get 100 XP when friends join!</p>

        <div class="invite-link-box">
          <input type="text" id="invite-link" class="invite-link-input" readonly>
          <button id="btn-copy-invite" class="invite-copy-btn" data-i18n="copy">Copy</button>
        </div>

        <div class="invite-share-buttons">
          <button id="btn-share-kakao" class="invite-share-btn kakao">
            <span>ğŸ’¬</span>
            <span>KakaoTalk</span>
          </button>
          <button id="btn-share-line" class="invite-share-btn line">
            <span>ğŸ’š</span>
            <span>LINE</span>
          </button>
          <button id="btn-share-copy" class="invite-share-btn copy">
            <span>ğŸ”—</span>
            <span data-i18n="copyLink">Copy Link</span>
          </button>
        </div>

        <div class="invite-stats">
          <div class="invite-stat">
            <span id="invite-count" class="invite-stat-value">0</span>
            <span class="invite-stat-label" data-i18n="friendsJoined">Friends Joined</span>
          </div>
          <div class="invite-stat">
            <span id="invite-xp" class="invite-stat-value">0</span>
            <span class="invite-stat-label" data-i18n="xpEarned">XP Earned</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Logout Button (for logged in users) -->
    <section id="logout-section" class="profile-section hidden">
      <button id="btn-logout" class="logout-btn" data-i18n="logout">Logout</button>
    </section>
  </main>

  <!-- Scripts -->
  <script src="../js/badges.js"></script>
  <script src="../js/level-xp.js"></script>
  <script src="../js/streak.js"></script>
  <script src="../js/user-data.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/referral.js"></script>
  <script src="../js/gamification-ui.js"></script>

  <script>
    // i18n translations
    const i18n = {
      ko: {
        profile: 'í”„ë¡œí•„',
        streak: 'ì¼ ì—°ì†',
        tests: 'í…ŒìŠ¤íŠ¸',
        badges: 'ë±ƒì§€',
        shares: 'ê³µìœ ',
        loginPrompt: 'ë¡œê·¸ì¸í•˜ë©´ ê¸°ë¡ì´ ì €ì¥ë¼ìš”!',
        login: 'ë¡œê·¸ì¸',
        myBadges: 'ë‚˜ì˜ ë±ƒì§€',
        viewAll: 'ì „ì²´ ë³´ê¸°',
        lockedBadges: 'ë¯¸íšë“ ë±ƒì§€',
        streakStatus: 'ìŠ¤íŠ¸ë¦­ í˜„í™©',
        currentStreak: 'í˜„ì¬ ì—°ì†',
        longestStreak: 'ìµœì¥:',
        days: 'ì¼',
        testHistory: 'í…ŒìŠ¤íŠ¸ ê¸°ë¡',
        mostCommon: 'ê°€ì¥ ë§ì´ ë‚˜ì˜¨ íƒ€ì…:',
        noTests: 'ì•„ì§ í…ŒìŠ¤íŠ¸ ê¸°ë¡ì´ ì—†ì–´ìš”',
        inviteFriends: 'ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°',
        inviteSubtitle: 'ì¹œêµ¬ê°€ ê°€ì…í•˜ë©´ 100 XP!',
        copy: 'ë³µì‚¬',
        copyLink: 'ë§í¬ ë³µì‚¬',
        friendsJoined: 'ëª… ê°€ì…',
        xpEarned: 'XP íšë“',
        logout: 'ë¡œê·¸ì•„ì›ƒ',
        home: 'í™ˆ',
        daily: 'ì¼ì¼ í…ŒìŠ¤íŠ¸',
        lifeSummary: 'ì¸ìƒ ìš”ì•½',
        copied: 'ë³µì‚¬ë¨!',
        nextMilestone: 'ë‹¤ìŒ ë§ˆì¼ìŠ¤í†¤ê¹Œì§€',
        daysLeft: 'ì¼ ë‚¨ìŒ'
      },
      en: {
        profile: 'Profile',
        streak: 'Day Streak',
        tests: 'Tests',
        badges: 'Badges',
        shares: 'Shares',
        loginPrompt: 'Login to save your progress!',
        login: 'Login',
        myBadges: 'My Badges',
        viewAll: 'View All',
        lockedBadges: 'Locked Badges',
        streakStatus: 'Streak Status',
        currentStreak: 'Current Streak',
        longestStreak: 'Longest:',
        days: 'days',
        testHistory: 'Test History',
        mostCommon: 'Most Common Type:',
        noTests: 'No tests yet',
        inviteFriends: 'Invite Friends',
        inviteSubtitle: 'Get 100 XP when friends join!',
        copy: 'Copy',
        copyLink: 'Copy Link',
        friendsJoined: 'Friends Joined',
        xpEarned: 'XP Earned',
        logout: 'Logout',
        home: 'Home',
        daily: 'Daily Test',
        lifeSummary: 'Life Summary',
        copied: 'Copied!',
        nextMilestone: 'Until next milestone',
        daysLeft: 'days left'
      }
    };

    let currentLang = 'ko';

    // Detect language
    function detectLanguage() {
      const saved = localStorage.getItem('ai-life-summary-lang');
      if (saved) return saved;
      const browserLang = navigator.language.split('-')[0];
      return i18n[browserLang] ? browserLang : 'ko';
    }

    function t(key) {
      return (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key;
    }

    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
    }

    // Initialize page
    async function init() {
      currentLang = detectLanguage();
      applyTranslations();

      // Initialize systems
      await userDataManager.initialize();
      gamificationUI.initialize(currentLang);
      referralSystem.initialize();

      // Load profile data
      loadProfileData();
      loadBadges();
      loadStreak();
      loadTestHistory();
      loadInviteSection();

      // Setup event listeners
      setupEventListeners();
    }

    function loadProfileData() {
      const userData = userDataManager.getUserData();
      const stats = userDataManager.getStatsSummary();

      // Profile info
      document.getElementById('profile-name').textContent = userData.displayName || (currentLang === 'ko' ? 'ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ì' : 'Guest User');

      // Avatar
      if (userData.photoURL) {
        document.getElementById('avatar-emoji').innerHTML = `<img src="${userData.photoURL}" alt="Avatar">`;
      }

      // Level
      document.getElementById('level-number').textContent = stats.level;
      document.getElementById('level-name').textContent = levelXPSystem.getLevelName(stats.level, currentLang);

      // XP Bar
      const progress = levelXPSystem.getXpProgress(stats.totalXp);
      document.getElementById('xp-text').textContent = progress.isMaxLevel
        ? 'MAX LEVEL'
        : `${progress.currentXp} / ${progress.maxXp} XP`;
      document.getElementById('xp-bar-fill').style.width = `${progress.percentage}%`;

      if (!progress.isMaxLevel) {
        document.getElementById('xp-next').textContent = `Next: Lv.${stats.level + 1}`;
      } else {
        document.getElementById('xp-next').textContent = '';
      }

      // Stats
      document.getElementById('stat-streak').textContent = stats.currentStreak;
      document.getElementById('stat-tests').textContent = stats.testCount;
      document.getElementById('stat-badges').textContent = stats.badgeCount;
      document.getElementById('stat-shares').textContent = stats.shareCount;

      // Show login prompt for guests
      if (stats.isGuest) {
        document.getElementById('login-prompt').classList.remove('hidden');
        document.getElementById('logout-section').classList.add('hidden');
      } else {
        document.getElementById('login-prompt').classList.add('hidden');
        document.getElementById('logout-section').classList.remove('hidden');
      }
    }

    function loadBadges() {
      const userData = userDataManager.getUserData();
      const earnedBadgeIds = userData.gamification?.badges || [];
      const allBadges = badgeSystem.getAllBadges();

      const earnedContainer = document.getElementById('earned-badges');
      const lockedContainer = document.getElementById('locked-badges');

      earnedContainer.innerHTML = '';
      lockedContainer.innerHTML = '';

      const earnedBadges = allBadges.filter(b => earnedBadgeIds.includes(b.id));
      const lockedBadges = allBadges.filter(b => !earnedBadgeIds.includes(b.id));

      // Update counts
      document.getElementById('badge-count').textContent = `(${earnedBadges.length}/${allBadges.length})`;
      document.getElementById('locked-count').textContent = `(${lockedBadges.length})`;

      // Render earned badges
      earnedBadges.forEach(badge => {
        const badgeEl = createBadgeElement(badge, false);
        earnedContainer.appendChild(badgeEl);
      });

      if (earnedBadges.length === 0) {
        earnedContainer.innerHTML = `<div class="empty-state"><span>ğŸ…</span><span>${currentLang === 'ko' ? 'ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ì–´ìš”' : 'No badges earned yet'}</span></div>`;
      }

      // Render locked badges (first 8)
      lockedBadges.slice(0, 8).forEach(badge => {
        const badgeEl = createBadgeElement(badge, true);
        lockedContainer.appendChild(badgeEl);
      });
    }

    function createBadgeElement(badge, isLocked) {
      const el = document.createElement('div');
      el.className = `badge-item rarity-${badge.rarity} ${isLocked ? 'locked' : ''}`;
      el.innerHTML = `
        <span class="badge-emoji">${isLocked ? 'â“' : badge.emoji}</span>
        <span class="badge-name">${badgeSystem.getBadgeName(badge.id, currentLang)}</span>
        <span class="badge-rarity ${badge.rarity}">${badgeSystem.getRarityConfig(badge.rarity).label[currentLang]}</span>
      `;

      if (!isLocked) {
        el.addEventListener('click', () => {
          gamificationUI.showBadgePopup(badge, currentLang);
        });
      }

      return el;
    }

    function loadStreak() {
      const userData = userDataManager.getUserData();
      const gamification = userData.gamification || {};

      // Current streak
      document.getElementById('streak-count').textContent = gamification.currentStreak || 0;
      document.getElementById('streak-emoji').textContent = streakSystem.getStreakEmoji(gamification.currentStreak || 0);
      document.getElementById('streak-best').textContent = gamification.longestStreak || 0;

      // Week display
      const weekData = streakSystem.getWeekDisplay({
        lastParticipationDate: gamification.lastParticipationDate,
        history: userData.dailyHistory || []
      });

      const weekContainer = document.getElementById('streak-week');
      weekContainer.innerHTML = weekData.map(day => `
        <div class="streak-day ${day.participated ? 'completed' : ''} ${day.isToday ? 'today' : ''} ${day.isFuture ? 'future' : ''}">
          <span class="streak-day-name">${currentLang === 'ko' ? day.dayName : day.dayNameEn}</span>
          <span class="streak-day-icon">${day.participated ? 'ğŸ”¥' : 'â—‹'}</span>
        </div>
      `).join('');

      // Next milestone
      const nextMilestone = streakSystem.getNextMilestone(gamification.currentStreak || 0);
      const milestoneContainer = document.getElementById('streak-next-milestone');

      if (nextMilestone) {
        milestoneContainer.innerHTML = `
          <span>${t('nextMilestone')}: ${nextMilestone.days}${t('days')}</span>
          <span class="milestone-remaining">${nextMilestone.daysRemaining} ${t('daysLeft')}</span>
        `;
      } else {
        milestoneContainer.innerHTML = `<span>ğŸ‰ ${currentLang === 'ko' ? 'ëª¨ë“  ë§ˆì¼ìŠ¤í†¤ ë‹¬ì„±!' : 'All milestones achieved!'}</span>`;
      }
    }

    function loadTestHistory() {
      const userData = userDataManager.getUserData();
      const history = userData.testHistory || [];
      const container = document.getElementById('test-history-list');

      // Most common type
      const mostCommon = userDataManager.getMostCommonType();
      if (mostCommon) {
        document.getElementById('most-common-type').classList.remove('hidden');
        document.getElementById('common-type-name').textContent = mostCommon.type;
        document.getElementById('common-type-count').textContent = `(${mostCommon.count}${currentLang === 'ko' ? 'íšŒ' : 'x'})`;
      }

      // Recent tests
      if (history.length === 0) {
        return; // Keep empty state
      }

      const recentTests = history.slice(-10).reverse();
      container.innerHTML = recentTests.map(test => `
        <div class="history-item">
          <span class="history-date">${test.date}</span>
          <span class="history-type">${test.testType}</span>
          ${test.result?.summary ? `<span class="history-summary">${test.result.summary}</span>` : ''}
        </div>
      `).join('');
    }

    function loadInviteSection() {
      const link = referralSystem.getReferralLink();
      document.getElementById('invite-link').value = link || '';

      const stats = referralSystem.getReferralStats();
      document.getElementById('invite-count').textContent = stats.count;
      document.getElementById('invite-xp').textContent = stats.xpEarned;
    }

    function setupEventListeners() {
      // Login button
      document.getElementById('btn-login')?.addEventListener('click', () => {
        gamificationUI.showLoginPrompt(currentLang);
      });

      // Copy invite link
      document.getElementById('btn-copy-invite')?.addEventListener('click', async () => {
        const success = await referralSystem.copyReferralLink();
        if (success) {
          gamificationUI.showToast('âœ…', t('copied'));
        }
      });

      // Share buttons
      document.getElementById('btn-share-kakao')?.addEventListener('click', () => {
        referralSystem.shareViaPlatform('kakao', currentLang);
      });

      document.getElementById('btn-share-line')?.addEventListener('click', () => {
        referralSystem.shareViaPlatform('line', currentLang);
      });

      document.getElementById('btn-share-copy')?.addEventListener('click', async () => {
        const success = await referralSystem.copyReferralLink();
        if (success) {
          gamificationUI.showToast('âœ…', t('copied'));
        }
      });

      // Logout
      document.getElementById('btn-logout')?.addEventListener('click', async () => {
        if (confirm(currentLang === 'ko' ? 'ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'Are you sure you want to logout?')) {
          await authSystem.signOut();
          window.location.reload();
        }
      });

      // Mobile menu handlers
      document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
        document.getElementById('mobile-menu').classList.remove('hidden');
      });

      document.getElementById('mobile-menu-close')?.addEventListener('click', () => {
        document.getElementById('mobile-menu').classList.add('hidden');
      });

      // Update language display on load
      var currentLangEl = document.getElementById('current-lang');
      if (currentLangEl) {
        currentLangEl.textContent = langFlags[currentLang] + ' ' + langNames[currentLang];
      }
    }

    // Initialize when DOM ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
